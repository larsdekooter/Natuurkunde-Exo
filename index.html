<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .container {
        width: 80%;
      }
      .wrapper {
        width: 40%;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
      }
      body {
        display: flex;
        align-items: center;
        flex-direction: column;
      }
      input[type="number"] {
        width: 9vw;
      }
      label {
        margin-left: auto;
      }
      .inputrow {
        width: 100%;
        display: flex;
        justify-content: space-between;
      }
      .inputrow div {
        width: 140px;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="inputrow">
        <input
          type="number"
          id="massaLabel"
          value="10"
          min="10"
          max="1000"
          step="10"
        />
        <input
          type="range"
          id="massa"
          value="0"
          min="10"
          max="1000"
          step="10"
        />
        <div>Massa (g)</div>
      </div>
      <div class="inputrow">
        <input
          type="number"
          id="veerconstanteLabel"
          value="0"
          min="0"
          max="10000"
          step="10"
        />
        <input
          type="range"
          id="veerconstante"
          value="0"
          min="0"
          max="10000"
          step="10"
        />
        <div>Veerconstante (N/m)</div>
      </div>
      <div class="inputrow">
        <input
          type="number"
          id="uittrekkingLabel"
          value="0"
          min="0"
          max="2"
          step="0.1"
        />
        <input
          type="range"
          id="uittrekking"
          value="0"
          min="0"
          max="2"
          step="0.1"
        />
        <div>Uittrekking (cm)</div>
      </div>
    </div>
    <div class="container">
      <canvas id="chart" class="chart" width="1" height="1"></canvas>
    </div>
    <script>
      function useState(initialValue) {
        let state = initialValue;
        const listeners = new Set();

        const getState = () => state;

        const setState = (newStateOrFn) => {
          const newState =
            typeof newStateOrFn === "function"
              ? newStateOrFn(state)
              : newStateOrFn;

          if (newState !== state) {
            state = newState;
            listeners.forEach((listener) => listener(state));
          }
        };

        const subscribe = (listener) => {
          listeners.add(listener);
          return () => listeners.delete(listener);
        };

        return [getState, setState, subscribe];
      }
      const [state, setState, onStateChange] = useState({
        massa: 10,
        veerconstante: 0,
        uittrekking: 0,
      });
      const ctx = document.getElementById("chart");
      let chart = new Chart(ctx, {});

      const veerconstanteInput = document.getElementById("veerconstante");
      const veerconstanteLabel = document.getElementById("veerconstanteLabel");
      veerconstanteInput.addEventListener("input", function (e) {
        const value = this.value;
        veerconstanteLabel.value = value;
        setState((state) => {
          state.veerconstante = value;
          return state;
        });
      });
      veerconstanteLabel.addEventListener("input", function (e) {
        const value = this.value;
        veerconstanteInput.value = value;
        setState((state) => {
          state.veerconstante = value;
          return state;
        });
      });

      const massaInput = document.getElementById("massa");
      const massaLabel = document.getElementById("massaLabel");
      massaInput.addEventListener("input", function (e) {
        const value = this.value;
        massaLabel.value = value;
        setState((state) => {
          state.massa = value;
          return state;
        });
      });
      massaLabel.addEventListener("input", function (e) {
        const value = this.value;
        massaInput.value = value;
        setState((state) => {
          state.massa = value;
          return state;
        });
      });

      const uittrekkingInput = document.getElementById("uittrekking");
      const uittrekkingLabel = document.getElementById("uittrekkingLabel");
      uittrekkingInput.addEventListener("input", function (e) {
        const value = this.value;
        uittrekkingLabel.value = value;
        setState((state) => {
          state.uittrekking = value;
          return state;
        });
      });
      uittrekkingLabel.addEventListener("input", function (e) {
        const value = this.value;
        uittrekkingInput.value = value;
        setState((state) => {
          state.uittrekking = value;
          return state;
        });
      });

      onStateChange((newState) => {
        console.log(newState);
        compute(newState.massa, newState.veerconstante, newState.uittrekking);
      });

      const compute = (m, C, u) => {
        let v = 0;
        let x = 0;
        const arr = [];

        const computeFwl = () =>
          (1 / 2) * 1.293 * (0.64 / 100) * (4.8 / 100) * 0.82 * v * v;

        for (let t = 0; t < 10; t += 0.1) {
          let Fres = 0;
          if (t === 0) {
            Fres = C * (u / 100) - computeFwl();
          } else {
            Fres = -computeFwl();
          }
          a = Fres / m;
          dv = a * 0.1;
          v = v + dv;
          dx = v * 0.1;
          x = x + dx;
          arr.push({ t: Math.round(t * 10) / 10, x });
        }
        chart.destroy();
        chart = new Chart(ctx, {
          type: "line",
          data: {
            labels: arr.map((comp) => comp.t),
            datasets: [
              {
                label: "-",
                data: arr.map((comp) => comp.x),
                pointRadius: 0,
              },
            ],
          },
        });
      };

      compute(
        massaLabel.value,
        veerconstanteLabel.value,
        uittrekkingLabel.value
      );
    </script>
  </body>
</html>
